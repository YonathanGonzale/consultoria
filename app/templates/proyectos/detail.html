{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
  <div>
    <h4 class="mb-1">{{ proyecto.nombre_proyecto or 'Proyecto sin título' }}</h4>
    <div class="text-muted small">
      {{ proyecto.institucion }} · {{ proyecto.subtipo or 'Sin subtipo' }} · Año {{ proyecto.anho or '—' }}
    </div>
  </div>
  <div class="d-flex gap-2 flex-wrap">
    {% if back_url %}
    <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Volver al tablero
    </a>
    {% endif %}
    <a href="{{ url_for('proyectos.editar', id_proyecto=proyecto.id_proyecto) }}" class="btn btn-primary btn-sm">
      <i class="bi bi-pencil"></i> Editar proyecto
    </a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body p-0">
        {% if hero_doc %}
          <a href="#" data-bs-toggle="modal" data-bs-target="#imageLightbox" data-image="{{ url_for('proyectos.ver_doc', id_doc=hero_doc.id_documento) }}" data-title="{{ hero_doc.nombre_original or 'Mapa del proyecto' }}">
            <img src="{{ url_for('proyectos.ver_doc', id_doc=hero_doc.id_documento) }}" class="w-100 rounded-top project-hero" alt="Mapa del proyecto">
          </a>
        {% else %}
          <div class="project-hero placeholder d-flex flex-column justify-content-center align-items-center text-muted">
            <i class="bi bi-image fs-1"></i>
            <span class="small">Sin mapa cargado</span>
          </div>
        {% endif %}
      </div>
    </div>

    {% if image_docs %}
    <div class="card mt-3">
      <div class="card-body">
        <h6 class="text-uppercase text-muted fw-semibold mb-3">Galería de imágenes</h6>
        <div class="row g-2">
          {% for img in image_docs %}
          <div class="col-6 col-md-4">
            <a href="#" class="gallery-thumb d-block" data-bs-toggle="modal" data-bs-target="#imageLightbox" data-image="{{ url_for('proyectos.ver_doc', id_doc=img.id_documento) }}" data-title="{{ img.nombre_original }}">
              <img src="{{ url_for('proyectos.ver_doc', id_doc=img.id_documento) }}" class="img-fluid rounded" alt="{{ img.nombre_original }}">
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card mt-3">
      <div class="card-body">
        <h6 class="text-uppercase text-muted fw-semibold mb-3">Resumen del proyecto</h6>
        <dl class="row small mb-0">
          <dt class="col-sm-5 text-muted">Estado</dt>
          <dd class="col-sm-7">{{ proyecto.estado.value.replace('_', ' ')|title if proyecto.estado else 'Pendiente' }}</dd>

          <dt class="col-sm-5 text-muted">Fecha emisión licencia</dt>
          <dd class="col-sm-7">{{ proyecto.fecha_emision_licencia.strftime('%d/%m/%Y') if proyecto.fecha_emision_licencia else '—' }}</dd>

          <dt class="col-sm-5 text-muted">Fecha vencimiento licencia</dt>
          <dd class="col-sm-7">{{ proyecto.fecha_vencimiento_licencia.strftime('%d/%m/%Y') if proyecto.fecha_vencimiento_licencia else '—' }}</dd>

          <dt class="col-sm-5 text-muted">EXP SIAM</dt>
          <dd class="col-sm-7">{{ proyecto.exp_siam or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Lugar</dt>
          <dd class="col-sm-7">{{ proyecto.lugar or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Distrito</dt>
          <dd class="col-sm-7">{{ proyecto.distrito or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Departamento</dt>
          <dd class="col-sm-7">{{ proyecto.departamento or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Finca</dt>
          <dd class="col-sm-7">{{ proyecto.finca or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Padrón</dt>
          <dd class="col-sm-7">{{ proyecto.padron or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Matrícula</dt>
          <dd class="col-sm-7">{{ proyecto.matricula or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Lote / Manzana</dt>
          <dd class="col-sm-7">
            {% if proyecto.lote or proyecto.manzana %}
              {{ proyecto.lote or '—' }} / {{ proyecto.manzana or '—' }}
            {% else %}
              —
            {% endif %}
          </dd>

          <dt class="col-sm-5 text-muted">Fracción</dt>
          <dd class="col-sm-7">{{ proyecto.fraccion or '—' }}</dd>

          <dt class="col-sm-5 text-muted">Superficie</dt>
          <dd class="col-sm-7">{{ '{:,.2f}'.format(proyecto.superficie) ~ ' ha' if proyecto.superficie is not none else '—' }}</dd>

          <dt class="col-sm-5 text-muted">Costo total</dt>
          <dd class="col-sm-7">{{ 'Gs. {:,.0f}'.format(proyecto.costo_total) if proyecto.costo_total is not none else '—' }}</dd>

          <dt class="col-sm-5 text-muted">Entrega (%)</dt>
          <dd class="col-sm-7">{{ '{:.2f}%'.format(proyecto.porcentaje_entrega) if proyecto.porcentaje_entrega is not none else '—' }}</dd>

          <dt class="col-sm-5 text-muted">Saldo restante</dt>
          <dd class="col-sm-7">{{ 'Gs. {:,.0f}'.format(proyecto.saldo_restante) if proyecto.saldo_restante is not none else '—' }}</dd>
        </dl>
      </div>
    </div>

    <div class="mt-3 d-none d-lg-block">
      {% include 'proyectos/_financial_card.html' %}
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column">
        <h6 class="text-uppercase text-muted fw-semibold mb-3">Documentos del proyecto</h6>

        {% if doc_groups %}
          <div class="accordion" id="docsAccordion">
            {% for group in doc_groups %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ loop.index }}">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse-{{ loop.index }}">
                  {{ group.title }} ({{ group.docs|length }})
                </button>
              </h2>
              <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#docsAccordion">
                <div class="accordion-body p-2">
                  <div class="list-group list-group-flush">
                    {% for doc in group.docs %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                      <div class="me-3">
                        <div class="fw-semibold">{{ doc.nombre_original or doc.tipo|title }}</div>
                        <div class="text-muted small">
                          {{ doc.uploaded_at.strftime('%d/%m/%Y') if doc.uploaded_at else '' }} · {{ doc.mime_type or 'archivo' }}
                        </div>
                      </div>
                      <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('proyectos.ver_doc', id_doc=doc.id_documento) }}" class="btn btn-outline-secondary" target="_blank" title="Ver">
                          <i class="bi bi-eye"></i>
                        </a>
                        <a href="{{ url_for('proyectos.descargar_doc', id_doc=doc.id_documento) }}" class="btn btn-outline-secondary" title="Descargar">
                          <i class="bi bi-download"></i>
                        </a>
                        <form method="post" action="{{ url_for('proyectos.eliminar_doc', id_doc=doc.id_documento) }}" onsubmit="return confirm('¿Eliminar este archivo?');">
                          <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-light border text-muted">
            <i class="bi bi-info-circle"></i> No hay documentos cargados todavía.
          </div>
        {% endif %}

        <form method="post" action="{{ url_for('proyectos.agregar_documentos', id_proyecto=proyecto.id_proyecto) }}" enctype="multipart/form-data" class="mt-4">
          <label class="form-label fw-semibold">Agregar nuevos documentos</label>
          <input type="file" name="documentos" class="form-control" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx,.xlsx,.zip,.rar,.shp">
          <div class="form-text">Podés seleccionar varios archivos; se categorizarán automáticamente.</div>
          <button class="btn btn-primary btn-sm mt-2">
            <i class="bi bi-cloud-upload"></i> Subir archivos
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="mt-3 d-lg-none">
  {% include 'proyectos/_financial_card.html' %}
</div>

<div class="modal fade" id="imageLightbox" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <img src="" alt="" class="img-fluid w-100">
      </div>
    </div>
  </div>
</div>

<style>
.project-hero {
  max-height: 340px;
  object-fit: contain;
  background-color: #f5f7fa;
}
.project-hero.placeholder {
  height: 340px;
}
.gallery-thumb img {
  height: 120px;
  object-fit: cover;
  width: 100%;
  transition: transform .2s ease, box-shadow .2s ease;
}

.gallery-thumb:hover img {
  transform: scale(1.03);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.2);
}

.financial-card .progress {
  height: 12px;
  background-color: #e9eff6;
}

.financial-card .progress-bar {
  background: linear-gradient(90deg, #4dabf7, #228be6);
}
</style>

<script>
  const imageLightbox = document.getElementById('imageLightbox');
  if (imageLightbox) {
    imageLightbox.addEventListener('show.bs.modal', (event) => {
      const trigger = event.relatedTarget;
      if (!trigger) return;
      const src = trigger.getAttribute('data-image');
      const title = trigger.getAttribute('data-title') || '';
      const modalImage = imageLightbox.querySelector('.modal-body img');
      const modalTitle = imageLightbox.querySelector('.modal-title span');
      modalImage.src = src;
      modalImage.alt = title;
      modalTitle.textContent = title;
    });
  }
</script>
{% endblock %}
