{% extends 'base.html' %}
{% block content %}
<div class="mb-3">
  <h5 class="mb-0">{{ cliente.nombre_razon_social }} - {{ institucion }}</h5>
  <div class="text-muted small">
    Año {{ ano }}
    {% if tipo_prefill %} - Tipo: {{ tipo_prefill }}{% endif %}
  </div>
</div>

<div class="row g-3">
  {% for estado, items in cols.items() %}
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-header text-capitalize fw-semibold">{{ estado }}</div>
      <div class="card-body min-vh-50" id="col-{{ estado }}" data-estado="{{ estado }}">
        {% for p in items %}
        <div class="border rounded p-2 mb-2 bg-light" data-id="{{ p.id_proyecto }}">
          <div class="d-flex justify-content-between small">
            <div class="text-muted">Año {{ p.anho }} • {{ p.tipo_tramite or '-' }}</div>
            <a class="text-decoration-none" href="{{ url_for('proyectos.editar', id_proyecto=p.id_proyecto) }}">Editar</a>
          </div>
          <div class="small">Propiedad: {{ p.propiedad.finca if p.propiedad else '-' }}</div>
          <div class="small">Plazo: {{ p.plazo_limite or '-' }}</div>
        </div>
        {% else %}
        <div class="text-muted small">Sin proyectos</div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal Nuevo Proyecto -->
<div class="modal fade" id="modalNuevo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('proyectos.crear_quick') }}" enctype="multipart/form-data">
        <div class="modal-header"><h5 class="modal-title">Nuevo Proyecto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id_cliente" value="{{ cliente.id_cliente }}">
          <input type="hidden" name="institucion" value="{{ institucion }}">
          <div class="mb-2">
            <label class="form-label">Año</label>
            <input type="number" class="form-control" name="anho" placeholder="{{ now().year if false else '' }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Tipo de trámite</label>
            <input class="form-control" name="tipo_tramite" value="{{ tipo_prefill or '' }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Estado</label>
            <select class="form-select" name="estado">
              <option>pendiente</option>
              <option>en proceso</option>
              <option>entregado</option>
              <option>finalizado</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Propiedad</label>
            <select class="form-select" name="id_propiedad">
              <option value="">Sin propiedad</option>
              {% for pr in propiedades %}
              <option value="{{ pr.id_propiedad }}">{{ pr.finca }} - {{ pr.departamento }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Firma de contrato</label>
              <input type="date" class="form-control" name="fecha_firma_contrato">
            </div>
            <div class="col">
              <label class="form-label">Plazo límite</label>
              <input type="date" class="form-control" name="plazo_limite">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Documentación anexa (opcional)</label>
            <input type="file" class="form-control" name="anexo" accept=".jpg,.jpeg,.png,.gif,.pdf,.webp,image/*">
            <div class="form-text">Podés adjuntar imágenes (JPG/PNG) o PDF como contrato, notas firmadas, mapas, etc.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  // Inicializa Sortable en cada columna
  document.querySelectorAll('[id^="col-"]').forEach(col => {
    new Sortable(col, {
      group: 'proyectos',
      animation: 150,
      onAdd: async (evt) => {
        const card = evt.item;
        const id = card.getAttribute('data-id');
        const estado = evt.to.getAttribute('data-estado');
        try {
          const res = await fetch(`/proyectos/${id}/estado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estado })
          });
          if (!res.ok) throw new Error('Error al actualizar');
        } catch (e) {
          alert('No se pudo actualizar el estado');
          evt.from.appendChild(card); // revertir
        }
      }
    });
  });
</script>
{% endblock %}
