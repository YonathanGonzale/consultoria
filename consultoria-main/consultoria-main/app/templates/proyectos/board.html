{% extends 'base.html' %}
{% block content %}
<div class="mb-3">
  <h5 class="mb-0">{{ cliente.nombre_razon_social }} - {{ institucion }}</h5>
  <div class="text-muted small">
    Año {{ ano }}
    {% if tipo_prefill %} - Tipo: {{ tipo_prefill }}{% endif %}
  </div>
</div>

<div class="row g-3">
  {% for estado, items in cols.items() %}
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-header text-capitalize fw-semibold">{{ estado }}</div>
      <div class="card-body min-vh-50" id="col-{{ estado }}" data-estado="{{ estado }}">
        {% for p in items %}
        <div class="border rounded p-2 mb-2 bg-light" data-id="{{ p.id_proyecto }}">
          <div class="d-flex justify-content-between small">
            <div class="text-muted">Año {{ p.anho }} • {{ p.tipo_tramite or '-' }}</div>
            <a class="text-decoration-none" href="{{ url_for('proyectos.editar', id_proyecto=p.id_proyecto) }}">Editar</a>
          </div>
          <div class="small">Propiedad: {{ p.propiedad.finca if p.propiedad else '-' }}</div>
          <div class="small">Plazo: {{ p.plazo_limite or '-' }}</div>
        </div>
        {% else %}
        <div class="text-muted small">Sin proyectos</div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  // Inicializa Sortable en cada columna
  document.querySelectorAll('[id^="col-"]').forEach(col => {
    new Sortable(col, {
      group: 'proyectos',
      animation: 150,
      onAdd: async (evt) => {
        const card = evt.item;
        const id = card.getAttribute('data-id');
        const estado = evt.to.getAttribute('data-estado');
        try {
          const res = await fetch(`/proyectos/${id}/estado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estado })
          });
          if (!res.ok) throw new Error('Error al actualizar');
        } catch (e) {
          alert('No se pudo actualizar el estado');
          evt.from.appendChild(card); // revertir
        }
      }
    });
  });
</script>
{% endblock %}
