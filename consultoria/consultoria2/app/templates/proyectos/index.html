{% extends "base.html" %}

{% block title %}Proyectos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Proyectos</h2>
    <a href="{{ url_for('proyectos.nuevo_proyecto') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nuevo Proyecto
    </a>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control" 
                       placeholder="Buscar por cliente, trámite o institución..." 
                       value="{{ filtros.q }}">
            </div>
            <div class="col-md-2">
                <select name="cliente_id" class="form-select">
                    <option value="">Todos los clientes</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id_cliente }}" 
                            {% if filtros.cliente_id|string == cliente.id_cliente|string %}selected{% endif %}>
                        {{ cliente.nombre_razon_social }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="institucion" class="form-select">
                    <option value="">Todas las instituciones</option>
                    {% for inst in instituciones %}
                    <option value="{{ inst }}" {% if filtros.institucion == inst %}selected{% endif %}>
                        {{ inst }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select name="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    {% for est in estados %}
                    <option value="{{ est }}" {% if filtros.estado == est %}selected{% endif %}>
                        {{ est|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <select name="anho" class="form-select">
                    <option value="">Año</option>
                    {% for año in anhos %}
                    <option value="{{ año }}" {% if filtros.anho|string == año|string %}selected{% endif %}>
                        {{ año }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de proyectos -->
<div class="row">
    {% if proyectos %}
        {% for proyecto, cliente, propiedad in proyectos %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">
                            <a href="{{ url_for('proyectos.detalle', id_proyecto=proyecto.id_proyecto) }}" 
                               class="text-decoration-none">
                                {{ proyecto.tipo_tramite }}
                            </a>
                        </h6>
                        <small class="text-muted">{{ proyecto.anho }}</small>
                    </div>
                    <span class="badge bg-info">{{ proyecto.institucion }}</span>
                </div>
                
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Cliente:</strong> 
                        <a href="{{ url_for('clientes.instituciones', id_cliente=cliente.id_cliente) }}" 
                           class="text-decoration-none">
                            {{ cliente.nombre_razon_social }}
                        </a>
                    </p>
                    
                    <p class="mb-2">
                        <strong>Propiedad:</strong> 
                        <a href="{{ url_for('propiedades.detalle_propiedad', id_propiedad=propiedad.id_propiedad) }}" 
                           class="text-decoration-none">
                            {{ propiedad.display_name if propiedad.display_name else 'Propiedad #' + propiedad.id_propiedad|string }}
                        </a>
                    </p>
                    
                    {% if proyecto.fecha_firma_contrato %}
                    <p class="mb-2">
                        <strong>Contrato:</strong> {{ proyecto.fecha_firma_contrato.strftime('%d/%m/%Y') }}
                    </p>
                    {% endif %}
                    
                    {% if proyecto.plazo_limite %}
                    <p class="mb-2">
                        <strong>Plazo:</strong> 
                        {{ proyecto.plazo_limite.strftime('%d/%m/%Y') }}
                    </p>
                    {% endif %}
                </div>
                
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div>
                        {% if proyecto.estado == 'finalizado' %}
                            <span class="badge bg-success">{{ proyecto.estado|title }}</span>
                        {% elif proyecto.estado == 'en proceso' %}
                            <span class="badge bg-warning">{{ proyecto.estado|title }}</span>
                        {% elif proyecto.estado == 'entregado' %}
                            <span class="badge bg-info">{{ proyecto.estado|title }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ proyecto.estado|title }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" 
                                   href="{{ url_for('proyectos.detalle', id_proyecto=proyecto.id_proyecto) }}">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" 
                                   href="{{ url_for('proyectos.editar_proyecto', id_proyecto=proyecto.id_proyecto) }}">
                                    <i class="bi bi-pencil"></i> Editar
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="POST" 
                                      action="{{ url_for('proyectos.eliminar_proyecto', id_proyecto=proyecto.id_proyecto) }}"
                                      onsubmit="return confirm('¿Está seguro de eliminar este proyecto?')" 
                                      class="d-inline">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-folder-x text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">
                    {% if filtros.q or filtros.cliente_id or filtros.institucion or filtros.estado or filtros.anho %}
                        No se encontraron proyectos con los filtros aplicados.
                    {% else %}
                        No hay proyectos registrados.
                    {% endif %}
                </p>
                <a href="{{ url_for('proyectos.nuevo_proyecto') }}" class="btn btn-primary">
                    Crear primer proyecto
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Resumen estadístico -->
{% if proyectos %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Resumen</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="h4 mb-0 text-primary">{{ proyectos|length }}</div>
                <small class="text-muted">Total</small>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-0 text-success">
                    {{ proyectos|selectattr('0.estado', 'equalto', 'finalizado')|list|length }}
                </div>
                <small class="text-muted">Finalizados</small>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-0 text-warning">
                    {{ proyectos|selectattr('0.estado', 'equalto', 'en proceso')|list|length }}
                </div>
                <small class="text-muted">En proceso</small>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-0 text-secondary">
                    {{ proyectos|selectattr('0.estado', 'equalto', 'pendiente')|list|length }}
                </div>
                <small class="text-muted">Pendientes</small>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}