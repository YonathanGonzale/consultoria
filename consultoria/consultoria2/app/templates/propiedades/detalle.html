{% extends "base.html" %}

{% block title %}Detalle Propiedad{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-house-door"></i> 
        Propiedad: {{ propiedad.finca or 'Sin finca' }}
    </h2>
    <div>
        <a href="{{ url_for('propiedades.editar_propiedad', id_propiedad=propiedad.id_propiedad) }}" 
           class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <a href="{{ url_for('propiedades.list_propiedades') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="row">
    <!-- Información de la propiedad -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Información de la Propiedad
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Cliente:</dt>
                            <dd class="col-sm-8">
                                <a href="{{ url_for('clientes.instituciones', id_cliente=cliente.id_cliente) }}" 
                                   class="text-decoration-none">
                                    {{ cliente.nombre_razon_social }}
                                </a>
                            </dd>
                            
                            <dt class="col-sm-4">Finca:</dt>
                            <dd class="col-sm-8">{{ propiedad.finca or '-' }}</dd>
                            
                            <dt class="col-sm-4">Matrícula:</dt>
                            <dd class="col-sm-8">{{ propiedad.matricula or '-' }}</dd>
                            
                            <dt class="col-sm-4">Padrón:</dt>
                            <dd class="col-sm-8">{{ propiedad.padron or '-' }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Superficie:</dt>
                            <dd class="col-sm-8">
                                {% if propiedad.superficie_ha %}
                                    {{ "{:,.1f}".format(propiedad.superficie_ha) }} ha
                                {% else %}
                                    -
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Departamento:</dt>
                            <dd class="col-sm-8">{{ propiedad.departamento or '-' }}</dd>
                            
                            <dt class="col-sm-4">Distrito:</dt>
                            <dd class="col-sm-8">{{ propiedad.distrito or '-' }}</dd>
                            
                            <dt class="col-sm-4">Coordenadas:</dt>
                            <dd class="col-sm-8">
                                {% if propiedad.coordenadas %}
                                    <small class="font-monospace">{{ propiedad.coordenadas }}</small>
                                {% else %}
                                    -
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if propiedad.mapa_url %}
                <div class="mt-3">
                    <h6>Mapa de la propiedad:</h6>
                    <div class="text-center">
                        <img src="{{ propiedad.mapa_url }}" class="img-fluid" 
                             style="max-height: 400px; border: 1px solid #dee2e6;" 
                             alt="Mapa de la propiedad"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="alert alert-warning" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> 
                            No se pudo cargar la imagen del mapa.
                            <br><small>URL: {{ propiedad.mapa_url }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Proyectos asociados -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-folder"></i> Proyectos Asociados ({{ proyectos|length }})
                </h5>
                <!-- Aquí podrías agregar un botón para crear nuevo proyecto -->
            </div>
            <div class="card-body">
                {% if proyectos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Año</th>
                                <th>Institución</th>
                                <th>Tipo de Trámite</th>
                                <th>Estado</th>
                                <th>Plazo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proyecto in proyectos %}
                            <tr>
                                <td>{{ proyecto.anho }}</td>
                                <td>
                                    <span class="badge bg-info">{{ proyecto.institucion }}</span>
                                </td>
                                <td>{{ proyecto.tipo_tramite }}</td>
                                <td>
                                    {% if proyecto.estado == 'finalizado' %}
                                        <span class="badge bg-success">{{ proyecto.estado|title }}</span>
                                    {% elif proyecto.estado == 'en proceso' %}
                                        <span class="badge bg-warning">{{ proyecto.estado|title }}</span>
                                    {% elif proyecto.estado == 'pendiente' %}
                                        <span class="badge bg-secondary">{{ proyecto.estado|title }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ proyecto.estado|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if proyecto.plazo_limite %}
                                        {{ proyecto.plazo_limite.strftime('%d/%m/%Y') }}
                                        {% set dias_restantes = (proyecto.plazo_limite - moment().date()).days %}
                                        {% if dias_restantes < 0 %}
                                            <br><small class="text-danger">Vencido</small>
                                        {% elif dias_restantes <= 7 %}
                                            <br><small class="text-warning">{{ dias_restantes }} días</small>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-folder-x text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">No hay proyectos asociados a esta propiedad</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Panel lateral -->
    <div class="col-md-4">
        <!-- Resumen -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Resumen
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h4 mb-0 text-primary">{{ proyectos|length }}</div>
                        <small class="text-muted">Proyectos</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0 text-success">
                            {{ proyectos|selectattr('estado', 'equalto', 'finalizado')|list|length }}
                        </div>
                        <small class="text-muted">Finalizados</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h4 mb-0 text-warning">
                            {{ proyectos|selectattr('estado', 'equalto', 'en proceso')|list|length }}
                        </div>
                        <small class="text-muted">En proceso</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0 text-secondary">
                            {{ proyectos|selectattr('estado', 'equalto', 'pendiente')|list|length }}
                        </div>
                        <small class="text-muted">Pendientes</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Acciones rápidas -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning"></i> Acciones Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('propiedades.editar_propiedad', id_propiedad=propiedad.id_propiedad) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> Editar Propiedad
                    </a>
                    <!-- Cuando implementes proyectos, puedes descomentar esto -->
                    <!--
                    <a href="{{ url_for('proyectos.nuevo_proyecto', id_propiedad=propiedad.id_propiedad) }}" 
                       class="btn btn-outline-success btn-sm">
                        <i class="bi bi-plus"></i> Nuevo Proyecto
                    </a>
                    -->
                    {% if propiedad.coordenadas %}
                    <button type="button" class="btn btn-outline-info btn-sm" 
                            onclick="copyToClipboard('{{ propiedad.coordenadas }}')">
                        <i class="bi bi-geo-alt"></i> Copiar Coordenadas
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar toast o mensaje de éxito
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    Coordenadas copiadas al portapapeles
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remover el toast después de que se oculte
        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    });
}
</script>
{% endblock %}