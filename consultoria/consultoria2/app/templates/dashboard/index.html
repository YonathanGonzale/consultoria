{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="bi bi-speedometer2"></i> Panel General de Gestión</h2>
  
  <!-- Filtros -->
  <div class="d-flex gap-2">
    <form method="GET" class="d-flex gap-2">
      <select name="cliente_id" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">Todos los clientes</option>
        {% for cliente in clientes %}
          <option value="{{ cliente.id_cliente }}" {% if cliente.id_cliente == cliente_id %}selected{% endif %}>
            {{ cliente.nombre_razon_social }}
          </option>
        {% endfor %}
      </select>
      
      <select name="año" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for año in años_disponibles %}
          <option value="{{ año }}" {% if año == año_filtro %}selected{% endif %}>{{ año }}</option>
        {% endfor %}
      </select>
      
      {% if cliente_id or año_filtro != 2024 %}
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-x-circle"></i> Limpiar
        </a>
      {% endif %}
    </form>
  </div>
</div>

{% if cliente_seleccionado %}
<div class="alert alert-info">
  <i class="bi bi-person-fill"></i> Mostrando datos para: <strong>{{ cliente_seleccionado.nombre_razon_social }}</strong> - Año {{ año_filtro }}
</div>
{% endif %}

<!-- Métricas principales -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="card text-bg-primary">
      <div class="card-body text-center">
        <h5 class="card-title"><i class="bi bi-people-fill"></i></h5>
        <h3>{{ total_clientes }}</h3>
        <p class="card-text mb-0">Clientes</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-bg-success">
      <div class="card-body text-center">
        <h5 class="card-title"><i class="bi bi-folder-fill"></i></h5>
        <h3>{{ proyectos_año }}</h3>
        <p class="card-text mb-0">Proyectos {{ año_filtro }}</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-bg-info">
      <div class="card-body text-center">
        <h5 class="card-title"><i class="bi bi-geo-alt-fill"></i></h5>
        <h3>{{ total_propiedades }}</h3>
        <p class="card-text mb-0">Propiedades</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card text-bg-warning">
      <div class="card-body text-center">
        <h5 class="card-title"><i class="bi bi-currency-dollar"></i></h5>
        <h3>${{ "%.0f"|format(total_facturado) }}</h3>
        <p class="card-text mb-0">Facturado</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card text-bg-danger">
      <div class="card-body text-center">
        <h5 class="card-title"><i class="bi bi-exclamation-triangle-fill"></i></h5>
        <h3>${{ "%.0f"|format(total_pendiente) }}</h3>
        <p class="card-text mb-0">Pendiente</p>
      </div>
    </div>
  </div>
</div>

<!-- Estados de proyectos -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card border-warning">
      <div class="card-body text-center">
        <h4 class="text-warning">{{ stats_estados.en_proceso }}</h4>
        <p class="mb-0">En Proceso</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-info">
      <div class="card-body text-center">
        <h4 class="text-info">{{ stats_estados.entregado }}</h4>
        <p class="mb-0">Entregados</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-success">
      <div class="card-body text-center">
        <h4 class="text-success">{{ stats_estados.finalizado }}</h4>
        <p class="mb-0">Finalizados</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-secondary">
      <div class="card-body text-center">
        <h4 class="text-secondary">{{ stats_estados.pendiente }}</h4>
        <p class="mb-0">Pendientes</p>
      </div>
    </div>
  </div>
</div>

<!-- Alertas de vencimientos -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card border-danger">
      <div class="card-body">
        <h5 class="card-title text-danger">
          <i class="bi bi-exclamation-triangle-fill"></i> Vencidos
        </h5>
        <h3 class="text-danger">{{ vencimientos_vencidos }}</h3>
        <a href="{{ url_for('vencimientos.list_vencimientos', estado='vencido') }}" class="btn btn-outline-danger btn-sm">
          Ver detalles
        </a>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card border-warning">
      <div class="card-body">
        <h5 class="card-title text-warning">
          <i class="bi bi-clock-fill"></i> Críticos (7 días)
        </h5>
        <h3 class="text-warning">{{ vencimientos_criticos }}</h3>
        <a href="{{ url_for('vencimientos.list_vencimientos', estado='proximo_vencer') }}" class="btn btn-outline-warning btn-sm">
          Ver detalles
        </a>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card border-info">
      <div class="card-body">
        <h5 class="card-title text-info">
          <i class="bi bi-calendar-check"></i> Próximos (30 días)
        </h5>
        <h3 class="text-info">{{ proximos_venc|length }}</h3>
        <a href="{{ url_for('vencimientos.dashboard') }}" class="btn btn-outline-info btn-sm">
          Dashboard completo
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos -->
<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Proyectos por Institución</h5>
      </div>
      <div class="card-body">
        <canvas id="chartInstituciones" height="300"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Proyectos por Mes</h5>
      </div>
      <div class="card-body">
        <canvas id="chartMeses" height="300"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Accesos directos -->
<div class="row g-3 mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Accesos Directos</h5>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-2">
            <a href="{{ url_for('proyectos.nuevo_proyecto') }}" class="btn btn-success w-100">
              <i class="bi bi-plus-circle"></i><br>Nuevo Proyecto
            </a>
          </div>
          <div class="col-md-2">
            <a href="{{ url_for('clientes.nuevo_cliente') }}" class="btn btn-primary w-100">
              <i class="bi bi-person-plus"></i><br>Nuevo Cliente
            </a>
          </div>
          <div class="col-md-2">
            <a href="{{ url_for('propiedades.nueva_propiedad') }}" class="btn btn-info w-100">
              <i class="bi bi-geo-alt-fill"></i><br>Nueva Propiedad
            </a>
          </div>
          <div class="col-md-2">
            <a href="{{ url_for('vencimientos.nuevo_vencimiento') }}" class="btn btn-warning w-100">
              <i class="bi bi-calendar-plus"></i><br>Nuevo Vencimiento
            </a>
          </div>
          <div class="col-md-2">
            <a href="{{ url_for('vencimientos.exportar_excel') }}" class="btn btn-secondary w-100">
              <i class="bi bi-download"></i><br>Exportar Datos
            </a>
          </div>
          <div class="col-md-2">
            <a href="{{ url_for('mades.index') }}" class="btn btn-dark w-100">
              <i class="bi bi-building"></i><br>MADES
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Próximos vencimientos detallados -->
<div class="row g-3">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-calendar-x"></i> Próximos Vencimientos (30 días)</h5>
        <a href="{{ url_for('vencimientos.list_vencimientos') }}" class="btn btn-outline-primary btn-sm">
          Ver todos
        </a>
      </div>
      <div class="card-body">
        {% if proximos_venc %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Tipo Documento</th>
                  <th>Fecha Vencimiento</th>
                  <th>Días Restantes</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for vencimiento, cliente in proximos_venc %}
                  {% set dias_restantes = vencimiento.dias_hasta_vencimiento() %}
                  <tr class="{% if dias_restantes <= 7 %}table-danger{% elif dias_restantes <= 15 %}table-warning{% endif %}">
                    <td>
                      <strong>{{ cliente.nombre_razon_social }}</strong>
                    </td>
                    <td>{{ vencimiento.tipo_documento }}</td>
                    <td>{{ vencimiento.fecha_vencimiento.strftime('%d/%m/%Y') }}</td>
                    <td>
                      {% if dias_restantes <= 0 %}
                        <span class="badge bg-danger">Vencido</span>
                      {% elif dias_restantes <= 7 %}
                        <span class="badge bg-warning">{{ dias_restantes }} días</span>
                      {% else %}
                        <span class="badge bg-info">{{ dias_restantes }} días</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge bg-secondary">{{ vencimiento.estado|title }}</span>
                    </td>
                    <td>
                      <a href="{{ url_for('vencimientos.detalle_vencimiento', id_vencimiento=vencimiento.id_vencimiento) }}" 
                         class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{{ url_for('vencimientos.marcar_notificado', id_vencimiento=vencimiento.id_vencimiento) }}" 
                         class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-bell"></i>
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4 text-muted">
            <i class="bi bi-calendar-check" style="font-size: 3rem;"></i>
            <p class="mt-2">No hay vencimientos próximos</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para gráficos
const datosInstituciones = {{ stats_instituciones|tojson }};
const datosMeses = {{ stats_meses|tojson }};

// Gráfico de instituciones
const ctxInstituciones = document.getElementById('chartInstituciones').getContext('2d');
const chartInstituciones = new Chart(ctxInstituciones, {
    type: 'doughnut',
    data: {
        labels: Object.keys(datosInstituciones),
        datasets: [{
            data: Object.values(datosInstituciones),
            backgroundColor: [
                '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Gráfico de meses
const ctxMeses = document.getElementById('chartMeses').getContext('2d');
const chartMeses = new Chart(ctxMeses, {
    type: 'line',
    data: {
        labels: datosMeses.map(m => m.mes + ' ' + m.año),
        datasets: [{
            label: 'Proyectos',
            data: datosMeses.map(m => m.cantidad),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}