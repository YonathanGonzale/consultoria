{% extends "base.html" %}

{% block title %}Detalle Vencimiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-calendar-x"></i> 
        Detalle de Vencimiento
    </h2>
    <div>
        <a href="{{ url_for('vencimientos.editar_vencimiento', id_vencimiento=vencimiento.id_vencimiento) }}" 
           class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <a href="{{ url_for('vencimientos.list_vencimientos') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>

<!-- Alerta de estado -->
{% set dias = vencimiento.dias_hasta_vencimiento() %}
{% if vencimiento.esta_vencido() %}
    <div class="alert alert-danger" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <h5 class="alert-heading">¡Documento Vencido!</h5>
                <p class="mb-0">Este documento venció hace {{ -dias }} día(s). Es necesario tomar acción inmediata.</p>
            </div>
        </div>
    </div>
{% elif dias is not none and dias <= 7 %}
    <div class="alert alert-warning" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-fill me-2"></i>
            <div>
                <h5 class="alert-heading">Vencimiento Próximo</h5>
                <p class="mb-0">Este documento vence en {{ dias }} día(s). Requiere atención urgente.</p>
            </div>
        </div>
    </div>
{% elif dias is not none and dias <= 30 %}
    <div class="alert alert-info" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
                <h5 class="alert-heading">Vencimiento en {{ dias }} días</h5>
                <p class="mb-0">Planifique la renovación de este documento.</p>
            </div>
        </div>
    </div>
{% endif %}

<div class="row">
    <!-- Información principal -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-text"></i> Información del Documento
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Cliente:</dt>
                            <dd class="col-sm-7">
                                <a href="{{ url_for('clientes.instituciones', id_cliente=cliente.id_cliente) }}" 
                                   class="text-decoration-none">
                                    {{ cliente.nombre_razon_social }}
                                </a>
                            </dd>
                            
                            <dt class="col-sm-5">Tipo de Documento:</dt>
                            <dd class="col-sm-7">
                                <span class="badge bg-secondary">{{ vencimiento.tipo_documento }}</span>
                            </dd>
                            
                            <dt class="col-sm-5">Estado:</dt>
                            <dd class="col-sm-7">
                                {% if vencimiento.esta_vencido() %}
                                    <span class="badge bg-danger">Vencido</span>
                                {% elif dias and dias <= 7 %}
                                    <span class="badge bg-warning">Urgente</span>
                                {% elif dias and dias <= 30 %}
                                    <span class="badge bg-info">Próximo</span>
                                {% else %}
                                    <span class="badge bg-success">Vigente</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Fecha de Emisión:</dt>
                            <dd class="col-sm-7">{{ vencimiento.fecha_emision.strftime('%d/%m/%Y') }}</dd>
                            
                            <dt class="col-sm-5">Fecha de Vencimiento:</dt>
                            <dd class="col-sm-7">
                                {{ vencimiento.fecha_vencimiento.strftime('%d/%m/%Y') }}
                                {% if dias is not none %}
                                    <br><small class="
                                        {% if dias < 0 %}text-danger
                                        {% elif dias <= 7 %}text-warning
                                        {% elif dias <= 30 %}text-info
                                        {% else %}text-success{% endif %}">
                                        {% if dias < 0 %}
                                            Vencido hace {{ -dias }} día(s)
                                        {% elif dias == 0 %}
                                            Vence hoy
                                        {% else %}
                                            Faltan {{ dias }} día(s)
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-5">Vigencia:</dt>
                            <dd class="col-sm-7">
                                {% set vigencia_dias = (vencimiento.fecha_vencimiento - vencimiento.fecha_emision).days %}
                                {{ vigencia_dias }} días
                                {% if vigencia_dias >= 365 %}
                                    ({{ "%.1f"|format(vigencia_dias/365) }} años)
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <!-- Información de la propiedad -->
                {% if propiedad %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6><i class="bi bi-geo-alt"></i> Propiedad Asociada</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Finca:</strong> {{ propiedad.finca or 'Sin finca' }}<br>
                                        {% if propiedad.matricula %}
                                            <strong>Matrícula:</strong> {{ propiedad.matricula }}<br>
                                        {% endif %}
                                        {% if propiedad.padron %}
                                            <strong>Padrón:</strong> {{ propiedad.padron }}<br>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if propiedad.superficie_ha %}
                                            <strong>Superficie:</strong> {{ "{:,.1f}".format(propiedad.superficie_ha) }} ha<br>
                                        {% endif %}
                                        <strong>Ubicación:</strong> 
                                        {{ propiedad.departamento }}
                                        {% if propiedad.distrito %}, {{ propiedad.distrito }}{% endif %}
                                        <br>
                                        <a href="{{ url_for('propiedades.detalle_propiedad', id_propiedad=propiedad.id_propiedad) }}" 
                                           class="btn btn-sm btn-outline-primary mt-2">
                                            <i class="bi bi-eye"></i> Ver Propiedad
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Historial de notificaciones -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bell"></i> Historial de Notificaciones
                </h5>
                {% if vencimiento.necesita_notificacion() %}
                    <a href="{{ url_for('vencimientos.marcar_notificado', id_vencimiento=vencimiento.id_vencimiento) }}" 
                       class="btn btn-sm btn-warning">
                        <i class="bi bi-bell-fill"></i> Marcar Notificado
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if vencimiento.notificaciones %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Tipo de Notificación</th>
                                <th>Fecha de Envío</th>
                                <th>Días antes del Vencimiento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for notificacion in vencimiento.notificaciones|sort(attribute='fecha_envio', reverse=true) %}
                            <tr>
                                <td>
                                    {% if notificacion.tipo == '30_dias' %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-calendar-event"></i> 30 días antes
                                        </span>
                                    {% elif notificacion.tipo == '7_dias' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-clock"></i> 7 días antes
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ notificacion.tipo }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ notificacion.fecha_envio.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% set dias_notif = (vencimiento.fecha_vencimiento - notificacion.fecha_envio).days %}
                                    {{ dias_notif }} días
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-bell-slash text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">No se han enviado notificaciones para este vencimiento</p>
                    
                    {% set tipo_notif = vencimiento.necesita_notificacion() %}
                    {% if tipo_notif %}
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            Este vencimiento requiere notificación de <strong>{{ tipo_notif.replace('_', ' ') }}</strong>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Panel lateral -->
    <div class="col-md-4">
        <!-- Resumen rápido -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-speedometer"></i> Resumen
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    {% if vencimiento.esta_vencido() %}
                        <div class="h1 text-danger mb-0">{{ -dias }}</div>
                        <small class="text-danger">DÍAS VENCIDO</small>
                    {% elif dias == 0 %}
                        <div class="h1 text-warning mb-0">HOY</div>
                        <small class="text-warning">VENCE HOY</small>
                    {% elif dias is not none %}
                        <div class="h1 {% if dias <= 7 %}text-warning{% elif dias <= 30 %}text-info{% else %}text-success{% endif %} mb-0">{{ dias }}</div>
                        <small class="{% if dias <= 7 %}text-warning{% elif dias <= 30 %}text-info{% else %}text-success{% endif %}">DÍAS RESTANTES</small>
                    {% endif %}
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="small text-muted">Notificaciones</div>
                        <div class="fw-bold">{{ vencimiento.notificaciones|length }}</div>
                    </div>
                    <div class="col-6">
                        <div class="small text-muted">Vigencia</div>
                        <div class="fw-bold">
                            {% set vigencia_dias = (vencimiento.fecha_vencimiento - vencimiento.fecha_emision).days %}
                            {% if vigencia_dias >= 365 %}
                                {{ "%.1f"|format(vigencia_dias/365) }} años
                            {% else %}
                                {{ vigencia_dias }} días
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Acciones rápidas -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning"></i> Acciones Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('vencimientos.editar_vencimiento', id_vencimiento=vencimiento.id_vencimiento) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> Editar Vencimiento
                    </a>
                    
                    {% if vencimiento.necesita_notificacion() %}
                        <a href="{{ url_for('vencimientos.marcar_notificado', id_vencimiento=vencimiento.id_vencimiento) }}" 
                           class="btn btn-warning btn-sm">
                            <i class="bi bi-bell-fill"></i> Marcar Notificado
                        </a>
                    {% endif %}
                    
                    {% if propiedad %}
                        <a href="{{ url_for('propiedades.detalle_propiedad', id_propiedad=propiedad.id_propiedad) }}" 
                           class="btn btn-outline-info btn-sm">
                            <i class="bi bi-geo-alt"></i> Ver Propiedad
                        </a>
                    {% endif %}
                    
                    <a href="{{ url_for('clientes.instituciones', id_cliente=cliente.id_cliente) }}" 
                       class="btn btn-outline-success btn-sm">
                        <i class="bi bi-person"></i> Ver Cliente
                    </a>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Información Adicional
                </h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>Creado:</strong> {{ moment(vencimiento.fecha_emision).format('DD/MM/YYYY') }}<br>
                    <strong>ID Vencimiento:</strong> #{{ vencimiento.id_vencimiento }}<br>
                    {% if propiedad %}
                        <strong>ID Propiedad:</strong> #{{ propiedad.id_propiedad }}<br>
                    {% endif %}
                    <strong>ID Cliente:</strong> #{{ cliente.id_cliente }}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}